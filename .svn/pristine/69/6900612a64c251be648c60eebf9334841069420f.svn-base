using AntDesigner.AppleGame;
using AntDesigner.AppleGame.EF;
using AntDesigner.AppleGame.interFace;
using AntDesigner.weiXinPay;
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Logging;
using System;
using WxPayAPI;

namespace AntDesigner.Controllers
{
    public class weixinPayController : myController
    {
        private readonly ILogger<weixinPayController> _logger;
        public weixinPayController(ILogger<weixinPayController> logger,IStorehouse IStorehouse, IHttpContextAccessor httpContextAccessor) : base(IStorehouse, httpContextAccessor)
        {
            _logger = logger;
        }
        [AllowAnonymous]
        public IActionResult getPayResult()
        {
            weixinPayManager weixinPayManager = new weixinPayManager();
            weixinPayManager.DcompletePayOrder = DcompletePayOrder;
            //string successStr = "";
            PayOrder payOrder = weixinPayManager.completePayOrderAndReback(httpContextAccessor.HttpContext, out string successStr);
            if (payOrder.success==true)
            {
                return Content(successStr);
            }
            else
            {
                return null;
            }
           
        }
        private PayOrder DcompletePayOrder(WxPayData WxPayData) //执行订单
        {
            PayOrder payOrder = IstoreHouse.findPayOrder(WxPayData);

            if (payOrder != null && payOrder.success==false )
            {
                Player player_ = IstoreHouse.getPlayerByweixinName(payOrder.weixinName);
                try
                {
                    player_.account.addmount(payOrder.amount, "充值");
                    
                    if (ManagePlayer.getOnlyInstance().weixinName==player_.introducerWeixinName&& payOrder.amount<=10)
                    {
                        player_.account.addmount(payOrder.amount * (decimal)0.02, "随机奖励");
                    }
                    else
                    {
                       Player introducer= IstoreHouse.getPlayerByweixinName(player_.introducerWeixinName);
                        introducer.account.addmount(payOrder.amount * (decimal)0.02, "分享奖励");
                    }
                    payOrder.success = true;
                    IstoreHouse.saveChanges();
                }
                catch (Exception)
                {

                    _logger.LogInformation("rechargeError:out_trade_no:"
                        + payOrder.out_trade_no+ 
                        "_weixinName:"+ payOrder.weixinName+
                        "_amount:"+payOrder.amount);

                }

            }
            return payOrder;
        }
    }
}
