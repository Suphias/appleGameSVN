using AntDesigner.AppleGame.interFace;
using System;
using System.ComponentModel.DataAnnotations.Schema;

using WxPayAPI;

namespace AntDesigner.weiXinPay
{
    public class RedPack : IIdCreateAndModifyTime
    {
        public int id { get; set; }
        public string weixinName { get; set; }
        public decimal amount { get; set; }
        public string err_code { get; set;}
        public string mch_billno { get; set; }
        public string send_listid { get; set;}
        [NotMapped]
       private WxPayData redPackRequest { get; set; }
        public RedPack() { }

    public bool request(string re_openid_,
                          decimal amount_,
                          string wishing_,
                          string send_name_,
                          string act_name_,
                          string remark_)
        {
            WxPayData redPackRequest = new WxPayData();
            redPackRequest.SetValue("re_openid", re_openid_);
            redPackRequest.SetValue("total_amount", (int)(amount_*100));
            redPackRequest.SetValue("wishing", wishing_);
            redPackRequest.SetValue("send_name", send_name_);
            redPackRequest.SetValue("act_name", act_name_);
            redPackRequest.SetValue("remark", remark_);
            WxPayData res = WxPayApi.WxRedPack(redPackRequest);
            if (res.GetValue("return_code").ToString() == "SUCCESS")
            {
                this.err_code = res.GetValue("err_code").ToString();
            }
            else
            {
                this.err_code = "requestFail";
            }
            if (res.GetValue("return_code").ToString() == "SUCCESS" &&
               res.GetValue("result_code").ToString() == "SUCCESS")
            {
                this.send_listid = res.GetValue("send_listid").ToString();
                this.weixinName = res.GetValue("re_openid").ToString();
                this.amount = decimal.Parse(res.GetValue("total_amount").ToString())/100;
                this.mch_billno = res.GetValue("mch_billno").ToString();
                return true;
            }
            else
            {
                return false;
            }
        }
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public DateTime createTime
        {
            get; set;
        }
        [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
        public DateTime? modifyTime
        {
            get; set;
        }
    }
}